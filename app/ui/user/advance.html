<F3:include href="common/header.html" />
<style>
	.parameter-input label,.parameter-input input, .parameter-input select{float:left;display:inline}
</style>

<script type="text/javascript">

		var cnt = 0;

		function addEvent(event){
			var cnt = $(this).attr('name').substr(0,1);
			var parentDiv = $('#search-' + cnt);
			var childName = $(this).val();
			var triggerAblity = false;
			var childToShow, childToHide;

			childName = childName.substring(childName.indexOf('-')+1);
			//如果是从基本选项选择的
			if(childName == 'ablity')
				triggerAblity = true;

			//如果是参数的基本选项，则不隐藏它们
			if($(this).hasClass('ablity-basic')){
				parentDiv.find(":input:not(.basic,.ablity-basic)").hide();
				parentDiv.find(".parameter-input").hide();
				parentDiv.find(".ablity-child").show();
				parentDiv.find(".parameter-num-input").show().find(":input").show();
				if(childName.indexOf('parameter') != -1){
					parentDiv.find(".parameter-num-input").hide();
					parentDiv.find("."+childName+"-input").show().children(':input').show();
				}
			}else{
				parentDiv.find(":input:not(.basic)").hide();
				parentDiv.find(".parameter-input").hide();
				parentDiv.find("."+childName+"-child").show().children(':input').val("");
			}

			if($(this).attr('name') == cnt+'-ablity') {
				parentDiv.find("[name="+cnt+"-pname]").attr('id', 'parameter'+cnt);
				var url = "{{@WEB_ROOT}}device/get/category?want=child&id=" + $(this).val();
				autoComplete_for_search("parameter"+cnt, url + "&json=true", "",cnt,{{@WEB_ROOT}});
			}

			$(".del").show();

			if(triggerAblity)
				parentDiv.find('[name='+cnt+'-ablity]').trigger('change');
		}

		function cloneTemplate() {
			cnt++;
			var template = $('#search_template').children().clone();
			$(template).find(":input").each(function(){
				$(this).attr("name", cnt + "-" + $(this).attr("name"));
				if($(this).hasClass('choice')){
					$("body").off("change", '.choice');
					$("body").on("change", '.choice', addEvent);
				}
			});
			template.attr('id','search-'+cnt);
			if(cnt == 1){
				template.find(".logic").attr('disabled', true).parent().find(".del").parent().hide();
			}
			$("#search").prepend(template);
		}

		function del(me) {
			$(me).parent().parent().remove();
		}

		$(function(){
			loading();
			cloneTemplate();
			$("#add").click(function(){ cloneTemplate(); });

			$("form").submit(function(event){
				$.post('{{@WEB_ROOT}}search/advance',$('form').serialize(),function(data) {
					$('#search-result').html(data);
				});
				event.preventDefault();
			});
		});

</script>

			<div id="search_template" style="display:none;">
				<div class="" id="search_box" style="margin-top:10px;position:relative">

					<div style="position:absolute;right:0px;">
						<button class="btn btn-danger del" onclick="del(this)">删除</button>
					</div>

					<select class="span2 basic logic" name="logic">
						<option selected value="AND">AND</option>
						<option value="OR">OR</option>
						<option value="NOT">NOT</option>
					</select>

					<select class="span2 choice basic" name="item">
						<option selected value="all-text">全部范围</option>
						<option value="title-text">型号名称</option>
						<option value="year-year">研制年代</option>
						<option value="user-text">装备对象</option>
						<option value="vendor-text">生产厂商</option>
						<option value="country-country">国家</option>
						<option value="status-text">现状</option>
						<option value="overview-text">概述</option>
						<option value="category1-category1">分类1</option>
						<option value="category2-category2">分类2</option>
						<option value="category3-category3">分类3</option>
						<option value="ablity-ablity">性能参数</option>
					</select>

					<select class="span2 category1-child" style="display: none;" name="1st_category">
						<F3:repeat group="{{@c.1st_category}}" value="{{@v}}" key="{{@id}}">
							<option value="{{@id}}">{{@v}}</option>
						</F3:repeat>
					</select>

					<select class="span2 category2-child" style="display: none;" name="2nd_category">
						<F3:repeat group="{{@c.2nd_category}}" value="{{@v}}" key="{{@id}}">
							<option value="{{@id}}">{{@v}}</option>
						</F3:repeat>
					</select>

					<select class="span2 category3-child" style="display: none;" name="3rd_category">
						<F3:repeat group="{{@c.3rd_category}}" value="{{@v}}" key="{{@id}}">
							<option value="{{@id}}">{{@v}}</option>
						</F3:repeat>
					</select>

					<!-- 年代输入框 -->
					<input type="text" class="span1 year-child" maxlength="4" style="display: none;" name="min_year">
					<input type="text" class="span1 year-child" maxlength="4" style="display: none;" name="max_year">

					<!--- 国家列表 -->
					<select class="span2 country-child" style="display: none;" name="country">
					<F3:repeat group="{{@country}}" value="{{@v}}" key="{{@id}}">
						<option value="{{@id}}">{{@v}}</option>
					</F3:repeat>
					</select>

					<!-- 文本输入框 -->
					<input type="text" class="span3 item text-child" name="str">

					<!--- 性能参数分类列表  -->
					<select class="span2 choice ablity-basic ablity-child" style="display: none;" name="ablity" id="category-xxx">
						<option value="-1">所有类别</option>   <!-- value=onecategory -->
					<F3:repeat group="{{@category}}" value="{{@v}}" key="{{@id}}">
						<option value="{{@id}}">{{@v}}</option>   <!-- value=onecategory -->
					</F3:repeat>
				</select>
				
					<!-- 属性列表 -->
					<input type="text" class="span2 ablity-basic ablity-child" style="display: none;" id="parameter" name="pname">
					<input type="hidden" name="name">  <!-- value=oneparameter -->

					<!-- 查询方式 -->
					<select class="span2 choice ablity-basic ablity-child" style="display:none;" name="search_type">
						<option >查询方式</option>
						<option value="num_mohu-parameter-num">数字(模糊)</option>
						<option value="num_yange-parameter-num">数字(严格)</option>
						<option value="str-parameter-str">文本</option>
					</select>

					<!-- 性能参数文本输入框 -->
					<div class="parameter-input parameter-str-input" style="display:none;height:30px;margin-top:8px">
						<label>请输入文本</label>
						<input type="text" class="span3" name="pstr">
					</div>
					<!-- 数字输入框 -->
					<div class="parameter-input parameter-num-input" style="display:none;height:30px;margin-top:10px">
						<label>值a</label>
						<input class="span1" name="min" type="text">
						<label>值b</label>
						<input class="span1" name="max" type="text">
						<label>单位</label>
						<select class="span2" name="unit">
			<F3:repeat group="{{@unit}}" value="{{@v}}" key="{{@id}}">
							<option value="{{@id}}">{{@v}}</option>
			</F3:repeat>
						</select>
						<label>数值类型</label>
						<select class="span2 select-hide" name="type">
			<F3:repeat group="{{@num_type}}" value="{{@v}}" key="{{@id}}">
							<option value="{{@id}}">{{@v}}</option>
			</F3:repeat>
						</select>
					</div>

					<hr>
				</div>
			</div>


	<div class="container">
		<div class="row">
			<div class="span10 offset1">
				<h3>高级检索</h3>
				<button type="button" class="btn btn-primary" id="add">添加</button>
				<form class="form-inline" id="search_form" action="" method="post">
					<div style="position:relative;zoom:1">
						<!--<h3 style="margin-left:10px;margin-top:50px;">已选条件</h3>-->
						<button style="position:absolute; right:0; bottom:5px" class="btn btn-primary" type="submit" id="sub">查询</button>
					</div>
					<div id="search">
					</div>
					<input type="hidden" name="page">
				</form>
			</div>
		</div>
		<div class = "row">
			<div style="display:none" class="loading">
				<img src="{{@WEB_ROOT}}static/img/loading.gif" />
			</div>
			<div class="span10 offset1" id="search-result">
			</div>
		</div>	
	</div><!-- Container -->

<F3:include href="common/footer.html" />
